name: Test Self-Hosted Runner 'runner-sv'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select Deployment Action'
        required: true
        type: choice
        default: 'Start-VirtualService'
        options:
          - Start-VirtualService
          - Stop-VirtualService
      
      vs_service_id:
        description: 'Target Virtual Service ID'
        required: true
        type: string
        default: 'Service ID'

jobs:
  my_sv_job:
    runs-on: self-hosted 
    
    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4


      - name: ðŸ·ï¸ Execution Info
        shell: powershell
        run: |
          Write-Output "Current Action: ${{ github.event.inputs.action }}"
          Write-Output "Target ID: ${{ github.event.inputs.vs_service_id }}"

      - name: Check Service Status
        id: check_status
        shell: powershell
        run: |
          $response = curl.exe -k -s -H "Authorization: Basic ${{ secrets.SV_TOKEN }}" -H "Accept: application/json" "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}"
          $json = $response | ConvertFrom-Json
          $currentState = $json.deploymentState
          Write-Output "Current Service Status: $currentState"
          echo "current_state=$currentState" >> $env:GITHUB_OUTPUT

      - name: ðŸ”„ Switch Service Mode - ${{ github.event.inputs.action }}
        shell: powershell
        run: |
          $action = "${{ github.event.inputs.action }}"
          $currentState = "${{ steps.check_status.outputs.current_state }}"

          if ($action -eq "Start-VirtualService") {
            $targetMode = "PassThrough"
            $expectedState = "Ready"
          } else {
            $targetMode = "Offline"
            $expectedState = "Down"
          }

          Write-Output "Action: $action"
          Write-Output "Current State: $currentState"
          Write-Output "Target Mode: $targetMode"

          if ($currentState -eq $expectedState) {
            Write-Output "âœ… Service is already in $expectedState state. No change needed."
          } else {
            Write-Output "ðŸš€ Switching service to $targetMode..."
            $bodyFile = "$env:TEMP\sv_body.json"
            Set-Content -Path $bodyFile -Value "{`"runtimeMode`": `"$targetMode`", `"messageLogging`": {`"enabled`": true, `"simulationReportEnabled`": true}}" -NoNewline
            Write-Output "Request Body: $(Get-Content $bodyFile)"

            $result = curl.exe -k -s -X PUT "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}" -H "Authorization: Basic ${{ secrets.SV_TOKEN }}" -H "Content-Type: application/json" -d "@$bodyFile"
            Write-Output "Result: $result"
            Remove-Item $bodyFile -ErrorAction SilentlyContinue
          }

      - name: âœ… Final Service Status
        shell: powershell
        run: |
          $finalResponse = curl.exe -k -s -H "Authorization: Basic ${{ secrets.SV_TOKEN }}" -H "Accept: application/json" "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}"
          $finalJson = $finalResponse | ConvertFrom-Json
          $finalState = $finalJson.deploymentState
          Write-Output "Final Service Status: $finalState"
          echo "final_state=$finalState" >> $env:GITHUB_OUTPUT