name: Test Self-Hosted Runner 'runner-sv'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select Deployment Action'
        required: true
        type: choice
        default: 'Start-VirtualService'
        options:
          - Start-VirtualService
          - Stop-VirtualService
          # - Record-VirtualService
          - Simulate-VirtualService
      vs_service_id:
        description: 'Target Virtual Service ID'
        required: true
        type: string
        default: 'Service ID'

jobs:
  my_sv_job:
    runs-on: self-hosted

    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: üîç Fetch Metadata (Get Model IDs)
        id: fetch_meta
        shell: powershell
        run: |
          $url = "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}"
          $response = curl.exe -k -s -X GET $url -H "accept: application/json" -H "Authorization: Basic ${{ secrets.SV_TOKEN }}"
          $json = $response | ConvertFrom-Json

          $currentState = $json.deploymentState
          $dataModelId = $json.dataModels[0].id
          $perfModelId = $json.performanceModels[0].id

          Write-Output "Service Name: $($json.name)"
          Write-Output "Current State: $currentState"
          Write-Output "Data Model Found: $dataModelId"

          echo "current_state=$currentState" >> $env:GITHUB_OUTPUT
          echo "dm_id=$dataModelId" >> $env:GITHUB_OUTPUT
          echo "pm_id=$perfModelId" >> $env:GITHUB_OUTPUT

      - name: üîÑ Execute Switch Mode - ${{ github.event.inputs.action }}
        shell: powershell
        run: |
          $action = "${{ github.event.inputs.action }}"
          $currentState = "${{ steps.fetch_meta.outputs.current_state }}"
          $dmId = "${{ steps.fetch_meta.outputs.dm_id }}"
          $pmId = "${{ steps.fetch_meta.outputs.pm_id }}"

          switch ($action) {
            "Start-VirtualService"    { $targetMode = "PassThrough"; $expectedState = "Ready" }
            "Stop-VirtualService"     { $targetMode = "Offline";     $expectedState = "Down" }
            "Record-VirtualService"   { $targetMode = "Learning";    $expectedState = "Ready" }
            "Simulate-VirtualService" { $targetMode = "Simulating";  $expectedState = "Ready" }
          }

          Write-Output "Target Mode: $targetMode"

          $payload = @{
              runtimeMode = $targetMode
              messageLogging = @{ enabled = $true; simulationReportEnabled = $true }
          }

          if ($targetMode -eq "Simulating" -or $targetMode -eq "Learning") {
              $payload.dataModelId = $dmId
              $payload.performanceModelId = $pmId
          }

          $bodyFile = "$env:TEMP\sv_payload.json"
          $jsonBody = $payload | ConvertTo-Json -Depth 3
          [System.IO.File]::WriteAllText($bodyFile, $jsonBody)

          $putUrl = "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}"
          $getUrl = "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}"
          $headers = @("-H", "Authorization: Basic ${{ secrets.SV_TOKEN }}", "-H", "Content-Type: application/json")
          $maxRetries = 3
          $delaySeconds = 10

          for ($attempt = 1; $attempt -le $maxRetries; $attempt++) {
              Write-Output "--- Attempt $attempt of $maxRetries ---"

              $result = curl.exe -k -s -X PUT $putUrl @headers -d "@$bodyFile"
              Write-Output "PUT Response: $result"

              Write-Output "Waiting $delaySeconds seconds for state to settle..."
              Start-Sleep -Seconds $delaySeconds

              $verify = curl.exe -k -s -X GET $getUrl -H "accept: application/json" -H "Authorization: Basic ${{ secrets.SV_TOKEN }}"
              $verifyJson = $verify | ConvertFrom-Json
              $actualState = $verifyJson.deploymentState

              Write-Output "Expected State: $expectedState | Actual State: $actualState"

              if ($actualState -eq $expectedState) {
                  Write-Output "‚úÖ State verified successfully on attempt $attempt"
                  break
              }

              if ($attempt -eq $maxRetries) {
                  Remove-Item $bodyFile
                  Write-Error "‚ùå State did not change to '$expectedState' after $maxRetries attempts (still '$actualState')"
                  exit 1
              }

              Write-Output "‚ö†Ô∏è State mismatch, retrying..."
          }

          Remove-Item $bodyFile
