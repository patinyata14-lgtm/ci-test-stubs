name: Test Self-Hosted Runner 'runner-sv'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select Deployment Action'
        required: true
        type: choice
        default: 'Start-VirtualService'
        options:
          - Start-VirtualService
          - Stop-VirtualService
          - Record-VirtualService
          - Simulate-VirtualService
      vs_service_id:
        description: 'Target Virtual Service ID'
        required: true
        type: string
        default: 'Service ID'

jobs:
  my_sv_job:
    runs-on: self-hosted

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Fetch Metadata (Get Model IDs)
        id: fetch_meta
        shell: powershell
        run: |
          $url = "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}"
          $response = curl.exe -k -s -X GET $url -H "accept: application/json" -H "Authorization: Basic ${{ secrets.SV_TOKEN }}"
          $json = $response | ConvertFrom-Json

          $currentState = $json.deploymentState
          $dataModelId = $json.dataModels[0].id
          $perfModelId = $json.performanceModels[0].id

          Write-Output "Service Name: $($json.name)"
          Write-Output "Current State: $currentState"
          Write-Output "Data Model Found: $dataModelId"

          echo "current_state=$currentState" >> $env:GITHUB_OUTPUT
          echo "dm_id=$dataModelId" >> $env:GITHUB_OUTPUT
          echo "pm_id=$perfModelId" >> $env:GITHUB_OUTPUT

      - name: ðŸ”„ Execute Switch Mode
        shell: powershell
        run: |
          $action = "${{ github.event.inputs.action }}"
          $currentState = "${{ steps.fetch_meta.outputs.current_state }}"
          $dmId = "${{ steps.fetch_meta.outputs.dm_id }}"
          $pmId = "${{ steps.fetch_meta.outputs.pm_id }}"

          switch ($action) {
            "Start-VirtualService"    { $targetMode = "PassThrough"; $expectedState = "Ready" }
            "Stop-VirtualService"     { $targetMode = "Offline";     $expectedState = "Down" }
            "Record-VirtualService"   { $targetMode = "Learning";    $expectedState = "Ready" }
            "Simulate-VirtualService" { $targetMode = "Simulating";  $expectedState = "Ready" }
          }

          Write-Output "Target Mode: $targetMode"

          $payload = @{
              runtimeMode = $targetMode
              messageLogging = @{ enabled = $true; simulationReportEnabled = $true }
          }

          if ($targetMode -eq "Simulating" -or $targetMode -eq "Learning") {
              $payload.dataModelId = $dmId
              $payload.performanceModelId = $pmId
          }

          $bodyFile = "$env:TEMP\sv_payload.json"
          $payload | ConvertTo-Json | Set-Content -Path $bodyFile -NoNewline -Encoding utf8

          $putUrl = "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}"
          $result = curl.exe -k -s -X PUT $putUrl `
                    -H "Authorization: Basic ${{ secrets.SV_TOKEN }}" `
                    -H "Content-Type: application/json" `
                    -d "@$bodyFile"

          Write-Output "API Response: $result"
          Remove-Item $bodyFile
