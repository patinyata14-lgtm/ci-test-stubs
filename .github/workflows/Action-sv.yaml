name: Test Self-Hosted Runner 'runner-sv'

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      action:
        description: 'Select Deployment Action'
        required: true
        type: choice
        default: 'Start-VirtualService'
        options:
          - Start-VirtualService
          - Stop-VirtualService
      
      vs_service_id: 
        description: 'Target Virtual Service ID'
        required: true
        type: string
        default: 'fdedfe36-872a-431e-aaad-751cc7e201e5'

jobs:
  my_sv_job:
    runs-on: self-hosted 
    
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: üè∑Ô∏è Execution Info
        run: |
          echo "Current Action: ${{ github.event.inputs.action }}"
          echo "Target ID: ${{ github.event.inputs.vs_service_id }}"

      - name: üîÑ Switch Service Mode
        run: |
          if [[ "${{ github.event.inputs.action }}" == "Start-VirtualService" ]]; then
            TARGET_MODE="PassThrough"
          else
            TARGET_MODE="Offline"
          fi

          echo "üöÄ Sending PUT request to set mode to: $TARGET_MODE"
          
          # ‡∏¢‡∏¥‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á PUT ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤
          curl -k -X PUT "https://10.0.10.133:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"runtimeMode\": \"$TARGET_MODE\",
            \"messageLogging\": {
              \"enabled\": true,
              \"simulationReportEnabled\": true
            }
          }"

      - name: üîç Check Status (Polling)
        run: |
          echo "‚è≥ Waiting for service to reach Ready state..."
          for i in {1..10}; do
            STATUS=$(curl -k -s "https://10.0.10.133:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}" | jq -r '.deploymentState')
            echo "Current Status: $STATUS"
            
            if [[ "$STATUS" == "Ready" ]]; then
              echo "‚úÖ Service is Ready and $TARGET_MODE!"
              exit 0
            fi
            sleep 3
          done
          
          echo "‚ùå Timeout: Service did not reach Ready state."
          exit 1