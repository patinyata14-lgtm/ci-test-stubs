name: Test Self-Hosted Runner 'runner-sv'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select Deployment Action'
        required: true
        type: choice
        default: 'Start-VirtualService'
        options:
          - Start-VirtualService
          - Stop-VirtualService
      
      vs_service_id:
        description: 'Target Virtual Service ID'
        required: true
        type: choice
        default: 'a380b409-65da-4249-b726-40074eb8235d'
        options:
          - a380b409-65da-4249-b726-40074eb8235d  # REST Service 3
          - 88739488-492d-45a8-9889-715dde894da7  # REST Service (Switch Service)

jobs:
  my_sv_job:
    runs-on: self-hosted 
    
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4


      - name: üè∑Ô∏è Execution Info
        shell: powershell
        run: |
          Write-Output "Current Action: ${{ github.event.inputs.action }}"
          Write-Output "Target ID: ${{ github.event.inputs.vs_service_id }}"

      - name: Check Service Status
        id: check_status
        shell: powershell
        run: |
          $response = curl.exe -k -s -H "Authorization: Basic ${{ secrets.SV_TOKEN }}" -H "Accept: application/json" "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}"
          $json = $response | ConvertFrom-Json
          $currentState = $json.deploymentState
          Write-Output "Current Service Status: $currentState"
          echo "current_state=$currentState" >> $env:GITHUB_OUTPUT

      - name: üîÑ Switch Service Mode
        shell: powershell
        run: |
          $action = "${{ github.event.inputs.action }}"
          $currentState = "${{ steps.check_status.outputs.current_state }}"

          if ($action -eq "Start-VirtualService") {
            $targetMode = "PassThrough"
            $expectedState = "Ready"
          } else {
            $targetMode = "Offline"
            $expectedState = "Down"
          }

          Write-Output "Action: $action"
          Write-Output "Current State: $currentState"
          Write-Output "Target Mode: $targetMode"

          if ($currentState -eq $expectedState) {
            Write-Output "‚úÖ Service is already in $expectedState state. No change needed."
          } else {
            Write-Output "üöÄ Switching service to $targetMode..."
            $body = @{
              runtimeMode = $targetMode
              messageLogging = @{
                enabled = $true
                simulationReportEnabled = $true
              }
            } | ConvertTo-Json

            $result = curl.exe -k -s -X PUT "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}" -H "Authorization: Basic ${{ secrets.SV_TOKEN }}" -H "Content-Type: application/json" -d $body
            Write-Output "Result: $result"
          }

      # - name: Check Service Status
      #   run: |
      #     RESPONSE=$(curl -k -s -H "Authorization: Basic ${{ secrets.SV_TOKEN }}" \
      #     -H "accept: application/json" \
      #     "https://localhost:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}" | jq {deploymentState})
      #     echo "Service Status Response: $RESPONSE"

      # - name: üîÑ Switch Service Mode
      #   run: |
      #     if [[ "${{ github.event.inputs.action }}" == "Start-VirtualService" ]]; then
      #       TARGET_MODE="PassThrough"
      #       EXPECTED_STATE="Ready"
      #     else
      #       TARGET_MODE="Offline"
      #       EXPECTED_STATE="Down"
      #     fi

      # echo "üöÄ Sending PUT request to set mode to: $TARGET_MODE"
      # curl -k -X PUT "https://10.0.10.133:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}" \
      # -H "Authorization: Basic ${{ secrets.SV_TOKEN }}" \
      # -H "Content-Type: application/json" \
      # -d "{
      #   \"runtimeMode\": \"$TARGET_MODE\",
      #   \"messageLogging\": {
      #     \"enabled\": true,
      #     \"simulationReportEnabled\": true
      #   }
      # }"

      # - name: üîç Check Status (Polling)
      #   run: |
      #     echo "‚è≥ Waiting for service to reach Ready state..."
      #     for i in {1..10}; do
      #       STATUS=$(curl -k -s -H "Authorization: Basic ${{ secrets.SV_TOKEN }}" \
      #       -H "accept: application/json" \
      #       "https://10.0.10.133:6085/api/v2/services/${{ github.event.inputs.vs_service_id }}")
            
      #       STATUS=$(echo "$RAW_JSON" | jq -r '.deploymentState')
      #       echo "Attempt $i: Current Status is [$STATUS]"

      #       if [[ "$STATUS" == "$EXPECTED_STATE" ]]; then
      #         echo "‚úÖ Service is $EXPECTED_STATE and $TARGET_MODE!"
      #         exit 0
      #       fi
      #       sleep 5
      #     done
          
      #     echo "‚ùå Timeout: Service did not reach $EXPECTED_STATE state."
      #     echo "Raw Response for Debug: $RAW_JSON"
      #     exit 1